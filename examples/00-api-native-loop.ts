/**
 * 00-api-native-loop.ts
 *
 * ç†è§£ Agentic Loop çš„æœ¬è´¨
 *
 * å…³é”®è®¤çŸ¥ï¼š
 * - OpenAI API æ²¡æœ‰å†…ç½®å¾ªç¯ï¼Œä½ éœ€è¦è‡ªå·±å†™ while å¾ªç¯
 * - LangChain createAgent å†…ç½®äº†å¾ªç¯ï¼Œä¸€æ¬¡è°ƒç”¨è‡ªåŠ¨å®Œæˆ
 *
 * è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº†ï¼š
 * 1. OpenAI åŸç”Ÿ API çš„å·¥ä½œæ–¹å¼ï¼ˆéœ€è¦æ‰‹åŠ¨å¾ªç¯ï¼‰
 * 2. LangChain åšäº†ä»€ä¹ˆï¼ˆå°è£…äº†å¾ªç¯ï¼‰
 *
 * è¿è¡Œ: npx tsx examples/00-api-native-loop.ts
 */

// ============================================================
// 1. OpenAI åŸç”Ÿ APIï¼šä½ éœ€è¦è‡ªå·±å†™å¾ªç¯
// ============================================================

/*
OpenAI Function Calling çš„å·¥ä½œæ–¹å¼ï¼š

```typescript
// å®šä¹‰å·¥å…·
const tools = [{
  type: "function",
  function: {
    name: "get_weather",
    description: "è·å–å¤©æ°”",
    parameters: {
      type: "object",
      properties: {
        location: { type: "string" }
      }
    }
  }
}];

// ä½ éœ€è¦è‡ªå·±å†™è¿™ä¸ªå¾ªç¯ï¼
while (true) {
  // 1. è°ƒç”¨ API
  const response = await openai.chat.completions.create({
    model: "gpt-4",
    messages,
    tools,
  });

  const message = response.choices[0].message;
  messages.push(message);

  // 2. æ£€æŸ¥æ˜¯å¦æœ‰ tool_calls
  if (message.tool_calls) {
    // 3. ä½ æ‰§è¡Œå·¥å…·
    for (const toolCall of message.tool_calls) {
      const result = await executeMyTool(toolCall);
      // 4. æŠŠç»“æœå‘å›å»
      messages.push({
        role: "tool",
        tool_call_id: toolCall.id,
        content: result
      });
    }
    // 5. ç»§ç»­å¾ªç¯
  } else {
    // 6. æ²¡æœ‰ tool_callsï¼Œç»“æŸ
    break;
  }
}
```

è¿™å°±æ˜¯ Agentic Loop çš„æœ¬è´¨ï¼š
  Think â†’ Act â†’ Observe â†’ Loop

OpenAI API åªæä¾›äº† "Think"ï¼ˆæ¨¡å‹è¿”å› tool_callsï¼‰ï¼Œ
"Act" å’Œ "Observe" è¦ä½ è‡ªå·±å®ç°ï¼Œå¾ªç¯ä¹Ÿè¦ä½ è‡ªå·±å†™ã€‚
*/

// ============================================================
// 2. LangChain createAgentï¼šå†…ç½®äº†å¾ªç¯
// ============================================================

/*
LangChain çš„ createAgent å°è£…äº†æ•´ä¸ªå¾ªç¯ï¼š

```typescript
import { createAgent } from "langchain";

const agent = createAgent({
  model: "openai:gpt-4",
  tools: [getWeatherTool],
});

// ä¸€æ¬¡è°ƒç”¨ï¼Œå†…éƒ¨è‡ªåŠ¨å®Œæˆæ‰€æœ‰å¾ªç¯
const result = await agent.invoke({
  messages: [{ role: "user", content: "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ" }]
});

// ç›´æ¥æ‹¿åˆ°æœ€ç»ˆç»“æœ
console.log(result.messages);
```

LangChain å¸®ä½ åšäº†ï¼š
âœ… å¾ªç¯é€»è¾‘ï¼ˆwhile + æ£€æŸ¥ tool_callsï¼‰
âœ… å·¥å…·æ‰§è¡Œ
âœ… ç»“æœå‘å›
âœ… é”™è¯¯å¤„ç†
âœ… æ¶ˆæ¯å†å²ç®¡ç†
*/

// ============================================================
// 3. å¯¹æ¯”æ€»ç»“
// ============================================================

/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API (åŸç”Ÿ)                                                   â”‚
â”‚                                                                     â”‚
â”‚  ä½  â†’ å‘è¯·æ±‚ â†’ æ¨¡å‹è¿”å› tool_calls â†’ ä½ æ‰§è¡Œ â†’ ä½ å‘ç»“æœ â†’ ç»§ç»­å¾ªç¯    â”‚
â”‚       â†‘                                                   â†“         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä½ è‡ªå·±å†™å¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LangChain createAgent                                              â”‚
â”‚                                                                     â”‚
â”‚  ä½  â†’ agent.invoke() â†’ å†…éƒ¨è‡ªåŠ¨å¾ªç¯ â†’ è¿”å›æœ€ç»ˆç»“æœ                   â”‚
â”‚                                                                     â”‚
â”‚  å¾ªç¯é€»è¾‘å·²å°è£…ï¼Œä½ åªéœ€è¦å®šä¹‰ tools                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LangChain çš„ä»·å€¼ï¼š
1. å°è£… Agentic Loopï¼ˆä¸ç”¨ä½ å†™ while å¾ªç¯ï¼‰
2. æä¾› Middleware æ‰©å±•ç‚¹ï¼ˆMemory, Skills, SubAgents ç­‰ï¼‰
3. ç»Ÿä¸€ä¸åŒæ¨¡å‹çš„ APIï¼ˆOpenAI, Claude, Qwen...ï¼‰
*/

// ============================================================
// 4. æ¼”ç¤º
// ============================================================

import "dotenv/config";
import { ChatOpenAI } from "@langchain/openai";

async function main() {
  console.log("\nğŸš€ 00-api-native-loop: ç†è§£ Agentic Loop\n");
  console.log("â•".repeat(60));
  console.log("å…³é”®è®¤çŸ¥ï¼š");
  console.log("  - OpenAI API æ²¡æœ‰å†…ç½®å¾ªç¯ï¼ˆä½ è¦è‡ªå·±å†™ whileï¼‰");
  console.log("  - LangChain createAgent å†…ç½®äº†å¾ªç¯");
  console.log("â•".repeat(60));

  console.log(`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API (åŸç”Ÿ)                                                   â”‚
â”‚                                                                     â”‚
â”‚  ä½  â†’ å‘è¯·æ±‚ â†’ æ¨¡å‹è¿”å› tool_calls â†’ ä½ æ‰§è¡Œ â†’ ä½ å‘ç»“æœ â†’ ç»§ç»­å¾ªç¯    â”‚
â”‚       â†‘                                                   â†“         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä½ è‡ªå·±å†™å¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LangChain createAgent                                              â”‚
â”‚                                                                     â”‚
â”‚  ä½  â†’ agent.invoke() â†’ å†…éƒ¨è‡ªåŠ¨å¾ªç¯ â†’ è¿”å›æœ€ç»ˆç»“æœ                   â”‚
â”‚                                                                     â”‚
â”‚  å¾ªç¯é€»è¾‘å·²å°è£…ï¼Œä½ åªéœ€è¦å®šä¹‰ tools                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  `);

  console.log("LangChain çš„ä»·å€¼ï¼š");
  console.log("  1. å°è£… Agentic Loopï¼ˆä¸ç”¨ä½ å†™ while å¾ªç¯ï¼‰");
  console.log("  2. æä¾› Middleware æ‰©å±•ç‚¹ï¼ˆMemory, Skills, SubAgentsï¼‰");
  console.log("  3. ç»Ÿä¸€ä¸åŒæ¨¡å‹çš„ APIï¼ˆOpenAI, Claude, Qwen...ï¼‰");
  console.log("");

  // ç®€å•æ¼”ç¤ºï¼šç›´æ¥ç”¨ LLMï¼ˆæ— å¾ªç¯ï¼Œæ—  Agentï¼‰
  const llm = new ChatOpenAI({
    model: process.env.DEFAULT_LLM_MODEL || "qwen-plus",
    apiKey: process.env.DASHSCOPE_API_KEY,
    configuration: {
      baseURL:
        process.env.DASHSCOPE_BASE_URL ||
        "https://dashscope.aliyuncs.com/compatible-mode/v1",
    },
  });

  console.log("â”€".repeat(60));
  console.log("æ¼”ç¤ºï¼šç›´æ¥è°ƒç”¨ LLMï¼ˆä¸æ˜¯ Agentï¼Œæ²¡æœ‰å¾ªç¯ï¼‰\n");

  const response = await llm.invoke("ç”¨ä¸€å¥è¯è§£é‡Šä»€ä¹ˆæ˜¯ Agentic Loop");
  console.log(`LLM å›å¤: ${response.content}\n`);

  console.log("â”€".repeat(60));
  console.log("ä¸‹ä¸€æ­¥ï¼š01-minimal-agent.ts ä½¿ç”¨ createAgent");
  console.log("â”€".repeat(60));
}

main().catch(console.error);
          